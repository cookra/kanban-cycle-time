<!DOCTYPE html>
<html>
<head>
    <title>Cycle Tim-LookbackAPI example</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var context=this.getContext(),project=context.getProject().ObjectID;console.log(project);var that=this,panel=Ext.create("Ext.panel.Panel",{layout:"hbox",itemId:"parentPanel",componentCls:"panel",items:[{xtype:"panel",width:600,itemId:"childPanel1"},{xtype:"panel",width:600,itemId:"childPanel2"}]});this.add(panel),Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["Name","c_Kanban","_UnformattedID","_TypeHierarchy"],filters:[{property:"__At",value:"current"},{property:"_TypeHierarchy",value:"HierarchicalRequirement"},{property:"_ProjectHierarchy",value:project},{property:"c_Kanban",operator:"exists",value:!0}],hydrate:["_TypeHierarchy","c_Kanban"],listeners:{load:this.onStoriesLoaded,scope:this}}).load({params:{compress:!0,removeUnauthorizedSnapshots:!0}})},onStoriesLoaded:function(store,data){var that=this,stories=[],id;_.each(data,function(record){var artifactType=record.get("_TypeHierarchy");console.log(artifactType),"HierarchicalRequirement"==artifactType[artifactType.length-1]?id="US"+record.get("_UnformattedID"):"Defect"==artifactType[artifactType.length-1]&&(id="DE"+record.get("_UnformattedID")),stories.push({Name:record.get("Name"),FormattedID:id,UnformattedID:record.get("_UnformattedID"),c_Kanban:record.get("c_Kanban")}),console.log(stories)});var myStore=Ext.create("Rally.data.custom.Store",{data:stories});this.down("#allStoriesGrid")?this.down("#allStoriesGrid").reconfigure(myStore):this.down("#childPanel1").add({xtype:"rallygrid",id:"allStoriesGrid",store:myStore,columnCfgs:[{text:"Formatted ID",dataIndex:"FormattedID"},{text:"Name",dataIndex:"Name",flex:1},{text:"Current Kanban State",dataIndex:"c_Kanban"}],listeners:{cellclick:function(grid,td,cellIndex,record,tr,rowIndex){id=grid.getStore().getAt(rowIndex).get("UnformattedID"),console.log("id",id),that.getStoryModel(id)}}})},getStoryModel:function(id){var workspace=this.getContext().getWorkspaceRef(),project=this.getContext().getProjectRef();console.log("workspace",workspace),console.log("project",project),console.log("get story model");var that=this;this.arr=[],Rally.data.ModelFactory.getModel({type:"User Story",context:{workspace:workspace,project:project},success:function(model){var allowedValuesStore=model.getField("c_Kanban").getAllowedValueStore();that.getDropdownValues(allowedValuesStore,id)}})},getDropdownValues:function(allowedValuesStore,id){var that=this;allowedValuesStore.load({scope:this,callback:function(records,operation,success){_.each(records,function(val){var v=val.get("StringValue");that.arr.push(v)}),console.log("arr",this.arr),that.getStoryById(id)}})},getStoryById:function(id){var that=this,snapStore=Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["c_Kanban","Blocked"],hydrate:["c_Kanban","Blocked"],filters:[{property:"_UnformattedID",value:id}],sorters:[{property:"_ValidTo",direction:"ASC"}]});snapStore.load({params:{compress:!0,removeUnauthorizedSnapshots:!0},callback:function(records,operation,success){that.onDataLoaded(records,id)}})},onDataLoaded:function(records,id){var times=[],measure="second",backlog=_.filter(records,function(record){return"backlog"===record.get("c_Kanban")});console.log("backlog",backlog);var cycleTimeFromBacklogToInProgress="";if(_.size(backlog)>0){var backlog1=_.first(backlog),backlog2=_.last(backlog),backlogDate1=new Date(backlog1.get("_ValidFrom"));if("9999-01-01T00:00:00.000Z"===backlog2.get("_ValidTo"))backlogDate2=new Date;else var backlogDate2=new Date(backlog2.get("_ValidTo"));cycleTimeFromBacklogToInProgress=Rally.util.DateTime.getDifference(backlogDate2,backlogDate1,measure)}times.push(cycleTimeFromBacklogToInProgress);var inProgress=_.filter(records,function(record){return"in-progress"===record.get("c_Kanban")});console.log("in-progress",inProgress);var cycleTimeFromInProgressToDone="";if(_.size(inProgress)>0){var inProgress1=_.first(inProgress),inProgress2=_.last(inProgress),inProgressDate1=new Date(inProgress1.get("_ValidFrom"));if("9999-01-01T00:00:00.000Z"===inProgress2.get("_ValidTo"))inProgressDate2=new Date;else var inProgressDate2=new Date(inProgress2.get("_ValidTo"));cycleTimeFromInProgressToDone=Rally.util.DateTime.getDifference(inProgressDate2,inProgressDate1,measure)}times.push(cycleTimeFromInProgressToDone);var done=_.filter(records,function(record){return"done"===record.get("c_Kanban")});console.log("done",done);var cycleTimeFromDoneToReleased="";if(_.size(done)>0){var done1=_.first(done),done2=_.last(done),doneDate1=new Date(done1.get("_ValidFrom"));if("9999-01-01T00:00:00.000Z"===done2.get("_ValidTo"))doneDate2=new Date;else var doneDate2=new Date(done2.get("_ValidTo"));cycleTimeFromDoneToReleased=Rally.util.DateTime.getDifference(doneDate2,doneDate1,measure)}times.push(cycleTimeFromDoneToReleased),this.arrShortened=_.without(this.arr,_.first(this.arr),_.last(this.arr)),console.log("this.arrShortened with first and last skipped",this.arrShortened),cycleTimes=_.zip(this.arrShortened,times),cycleTimes=_.object(cycleTimes);var cycleTimesArray=[];cycleTimesArray.push(cycleTimes),console.log("cycleTimesArray",cycleTimesArray);var store=Ext.create("Rally.data.custom.Store",{data:cycleTimesArray,pageSize:100}),columnConfig=[];_.each(cycleTimes,function(c,key){var columnConfigElement=_.object(["text","dataIndex","flex"],["time spent in "+key,key,1]);columnConfig.push(columnConfigElement)});var title="Kanban cycle time for US"+id+" in "+measure+"s";this.grid?this.down("#grid2").reconfigure(store):this.grid=this.down("#childPanel2").add({xtype:"rallygrid",title:title,itemId:"grid2",store:store,columnCfgs:columnConfig})}});

            Rally.launchApp('CustomApp', {
                name:"Cycle Tim-LookbackAPI example",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
